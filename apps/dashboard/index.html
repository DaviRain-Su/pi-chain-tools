<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NEAR Agent Dashboard</title>
    <style>
      :root {
        color-scheme: dark;
        --bg: #0b1020;
        --card: #151b2d;
        --text: #e8eefc;
        --muted: #96a3c7;
      }
      body { margin: 0; font-family: Inter, ui-sans-serif, system-ui, sans-serif; background: var(--bg); color: var(--text); }
      .wrap { max-width: 1060px; margin: 0 auto; padding: 24px; }
      .grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
      .card { background: var(--card); border: 1px solid #222b47; border-radius: 12px; padding: 14px; }
      .muted { color: var(--muted); }
      input, button { border-radius: 8px; border: 1px solid #2d3656; background: #0e1529; color: var(--text); padding: 8px 10px; }
      button { cursor: pointer; }
      table { width: 100%; border-collapse: collapse; }
      td, th { padding: 8px 0; border-bottom: 1px solid #232c49; text-align: left; }
      .ok { color: #8ff0a4; }
      .warn { color: #ffd27d; }
      .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      h3 { margin-top: 0; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>NEAR Agent Dashboard</h1>
      <p class="muted">Portfolio + Burrow + worker/runtime status in one page.</p>
      <div class="row" style="margin-bottom:16px">
        <input id="accountId" size="36" placeholder="account.near" />
        <button id="refresh">Refresh</button>
        <span id="meta" class="muted"></span>
      </div>

      <div class="grid">
        <div class="card"><h3>NEAR Wallet</h3><div id="near">-</div></div>
        <div class="card"><h3>Burrow Registration</h3><div id="burrowReg">-</div></div>
        <div class="card"><h3>Yield Worker</h3><div id="worker">-</div></div>
      </div>

      <div class="card" style="margin-top:16px">
        <h3>Yield Health</h3>
        <div id="yieldHealth" class="muted">-</div>
      </div>

      <div class="card" style="margin-top:16px">
        <h3>Strategy View</h3>
        <div id="strategy" class="muted">-</div>
      </div>

      <div class="card" style="margin-top:16px">
        <h3>Burrow Positions</h3>
        <div id="burrowPos" class="muted">-</div>
      </div>

      <div class="card" style="margin-top:16px">
        <h3>Tracked Token Balances</h3>
        <table>
          <thead><tr><th>Token</th><th>Balance</th><th>~USD</th><th>Status</th></tr></thead>
          <tbody id="tokens"></tbody>
        </table>
      </div>

      <div class="card" style="margin-top:16px">
        <h3>Recent Executions (local session)</h3>
        <div class="row" style="margin-bottom:8px">
          <button id="exportCsv">Export snapshot CSV</button>
          <span id="exportMeta" class="muted"></span>
        </div>
        <table>
          <thead><tr><th>Time</th><th>Tool</th><th>Tx Hash</th></tr></thead>
          <tbody id="txs"></tbody>
        </table>
      </div>

      <div class="card" style="margin-top:16px">
        <h3>Action History</h3>
        <table>
          <thead><tr><th>Time</th><th>Action</th><th>Status</th><th>Summary</th></tr></thead>
          <tbody id="actions"></tbody>
        </table>
      </div>

      <div class="card" style="margin-top:16px">
        <h3>Action Console</h3>
        <p class="muted">Supports command build + confirmed direct execution for selected actions.</p>
        <div class="row">
          <input id="wrapAmount" placeholder="Wrap amount NEAR (e.g. 1)" size="24" />
          <button id="buildWrap">Build wrap command</button>
        </div>
        <div class="row" style="margin-top:8px">
          <input id="supplyRaw" placeholder="Supply raw (USDt, e.g. 1000000)" size="24" />
          <button id="buildSupply">Build supply command</button>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="execWrap">Execute wrap (confirmed)</button>
          <button id="execSupply">Execute supply USDt (confirmed)</button>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="buildWorkerDry">Build worker dry-run start</button>
          <button id="buildWorkerStop">Build worker stop</button>
        </div>
        <div style="margin-top:10px">
          <textarea id="cmdOut" rows="6" style="width:100%;border-radius:8px;border:1px solid #2d3656;background:#0e1529;color:#e8eefc;padding:8px"></textarea>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="copyCmd">Copy command</button>
          <span id="cmdMeta" class="muted"></span>
        </div>
      </div>
    </div>

    <script>
      const accountInput = document.getElementById("accountId");
      const refreshBtn = document.getElementById("refresh");
      const nearEl = document.getElementById("near");
      const burrowRegEl = document.getElementById("burrowReg");
      const workerEl = document.getElementById("worker");
      const yieldHealthEl = document.getElementById("yieldHealth");
      const strategyEl = document.getElementById("strategy");
      const burrowPosEl = document.getElementById("burrowPos");
      const metaEl = document.getElementById("meta");
      const tokensEl = document.getElementById("tokens");
      const txsEl = document.getElementById("txs");
      const exportCsvBtn = document.getElementById("exportCsv");
      const exportMetaEl = document.getElementById("exportMeta");
      const actionsEl = document.getElementById("actions");
      const wrapAmountEl = document.getElementById("wrapAmount");
      const supplyRawEl = document.getElementById("supplyRaw");
      const buildWrapBtn = document.getElementById("buildWrap");
      const buildSupplyBtn = document.getElementById("buildSupply");
      const buildWorkerDryBtn = document.getElementById("buildWorkerDry");
      const buildWorkerStopBtn = document.getElementById("buildWorkerStop");
      const execWrapBtn = document.getElementById("execWrap");
      const execSupplyBtn = document.getElementById("execSupply");
      const cmdOutEl = document.getElementById("cmdOut");
      const copyCmdBtn = document.getElementById("copyCmd");
      const cmdMetaEl = document.getElementById("cmdMeta");

      function rowsToText(rows) {
        if (!rows || rows.length === 0) return "none";
        return rows.map((r) => `${r.symbol}: ${r.amount}`).join(" · ");
      }

      function parseNum(value) {
        const n = Number.parseFloat(String(value || "0"));
        return Number.isFinite(n) ? n : 0;
      }

      function computeYieldHealth(snapshot) {
        const coll = snapshot?.burrow?.collateral || [];
        if (coll.length === 0) {
          return "No stable collateral yet.";
        }
        const rows = coll.map((r) => ({
          symbol: r.symbol,
          amount: parseNum(r.amount),
          apr: parseNum(r.apr) * 100,
        }));
        const total = rows.reduce((sum, r) => sum + r.amount, 0);
        const weightedApr = total > 0 ? rows.reduce((sum, r) => sum + r.amount * r.apr, 0) / total : 0;
        const composition = rows
          .sort((a, b) => b.amount - a.amount)
          .map((r) => `${r.symbol} ${(total > 0 ? (r.amount / total) * 100 : 0).toFixed(1)}% @ ${r.apr.toFixed(2)}%`)
          .join(" · ");
        return `Estimated weighted APR: ${weightedApr.toFixed(2)}% · Collateral total: ${total.toFixed(6)} · ${composition}`;
      }

      function toCsv(snapshot) {
        const lines = [
          ["section", "key", "value"],
          ["meta", "accountId", snapshot.accountId],
          ["meta", "updatedAt", snapshot.updatedAt],
          ["near", "available", snapshot.near.available],
          ["near", "locked", snapshot.near.locked],
        ];
        for (const row of snapshot.tokens || []) {
          lines.push(["token", row.symbol, row.amount]);
        }
        for (const row of snapshot.burrow?.collateral || []) {
          lines.push(["burrow_collateral", row.symbol, row.amount]);
        }
        return lines.map((cols) => cols.map((c) => `"${String(c).replaceAll('"', '""')}"`).join(",")).join("\n");
      }

      let lastSnapshot = null;

      async function load() {
        const accountId = accountInput.value.trim();
        const query = accountId ? `?accountId=${encodeURIComponent(accountId)}` : "";
        const res = await fetch(`/api/snapshot${query}`);
        const data = await res.json();
        if (!res.ok) {
          metaEl.textContent = `Error: ${data.error || "Unknown"}`;
          return;
        }

        lastSnapshot = data;
        accountInput.value = data.accountId;
        metaEl.textContent = `Updated: ${new Date(data.updatedAt).toLocaleString()} · RPC: ${data.rpcUrl}`;
        nearEl.innerHTML = `${data.near.available} NEAR <span class="muted">(~$${data.near.usd.toFixed(2)})</span><br/><span class="muted">locked: ${data.near.locked}</span>`;

        burrowRegEl.innerHTML = data.burrow.registered ? `<span class="ok">Registered</span>` : `<span class="warn">Not registered</span>`;
        burrowPosEl.innerHTML = `Collateral: ${rowsToText(data.burrow.collateral)}<br/>Supplied: ${rowsToText(data.burrow.supplied)}<br/>Borrowed: ${rowsToText(data.burrow.borrowed)}`;
        yieldHealthEl.textContent = computeYieldHealth(data);

        if (data.worker) {
          workerEl.innerHTML = `<span class="ok">${data.worker.status}</span> · ${data.worker.dryRun ? "dry-run" : "live"}<br/><span class="muted">cycles: ${data.worker.cycleCount} · last: ${data.worker.lastCycleAt || "-"}</span>`;
        } else {
          workerEl.innerHTML = `<span class="warn">No worker status found in local session log</span>`;
        }

        if (data.strategy) {
          const rows = (data.strategy.currentStableCollateral || [])
            .map((r) => `${r.symbol}: ${r.amount} (APR ${(Number(r.apr || 0) * 100).toFixed(2)}%)`)
            .join("<br/>");
          strategyEl.innerHTML = `${data.strategy.recommendation}<br/><br/><span class="muted">Stable collateral APR ranking</span><br/>${rows || "none"}`;
        } else {
          strategyEl.innerHTML = `<span class="warn">No strategy data</span>`;
        }

        tokensEl.innerHTML = "";
        for (const row of data.tokens) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${row.symbol}</td><td>${row.amount}</td><td>$${(row.usd || 0).toFixed(2)}</td><td>${row.error ? `<span class="warn">${row.error}</span>` : "ok"}</td>`;
          tokensEl.appendChild(tr);
        }

        txsEl.innerHTML = "";
        for (const tx of data.recentTxs || []) {
          const tr = document.createElement("tr");
          const hash = tx.explorerUrl ? `<a href="${tx.explorerUrl}" target="_blank" rel="noreferrer">${tx.txHash}</a>` : tx.txHash;
          tr.innerHTML = `<td>${new Date(tx.timestamp).toLocaleString()}</td><td>${tx.tool}</td><td>${hash}</td>`;
          txsEl.appendChild(tr);
        }

        actionsEl.innerHTML = "";
        for (const row of data.actionHistory || []) {
          const tr = document.createElement("tr");
          const status = row.status === "success" ? `<span class="ok">success</span>` : `<span class="warn">error</span>`;
          tr.innerHTML = `<td>${new Date(row.timestamp).toLocaleString()}</td><td>${row.action}</td><td>${status}</td><td>${row.summary || ""}</td>`;
          actionsEl.appendChild(tr);
        }
      }

      function setCommand(text) {
        cmdOutEl.value = text;
        cmdMetaEl.textContent = "Command generated";
      }

      function currentAccount() {
        return (accountInput.value || "davirain8.near").trim();
      }

      buildWrapBtn.addEventListener("click", () => {
        const amount = (wrapAmountEl.value || "1").trim();
        setCommand(`near contract call-function as-transaction wrap.near near_deposit json-args '{}' prepaid-gas '100 Tgas' attached-deposit '${amount} NEAR' sign-as ${currentAccount()} network-config mainnet sign-with-keychain send`);
      });

      buildSupplyBtn.addEventListener("click", () => {
        const raw = (supplyRawEl.value || "1000000").trim();
        setCommand(`near_supplyBurrow network=mainnet rpcUrl=https://1rpc.io/near tokenId=usdt.tether-token.near amountRaw=${raw} asCollateral=true confirmMainnet=true`);
      });

      buildWorkerDryBtn.addEventListener("click", () => {
        setCommand(`near_yieldWorkerStart network=mainnet accountId=${currentAccount()} dryRun=true intervalSeconds=300 minAprDelta=0.5 topN=5`);
      });

      buildWorkerStopBtn.addEventListener("click", () => {
        setCommand(`near_yieldWorkerStop network=mainnet accountId=${currentAccount()}`);
      });

      copyCmdBtn.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(cmdOutEl.value || "");
          cmdMetaEl.textContent = "Copied";
        } catch {
          cmdMetaEl.textContent = "Copy failed";
        }
      });

      async function executeAction(payload) {
        const ok = window.confirm("This will execute an on-chain transaction. Continue?");
        if (!ok) return;
        cmdMetaEl.textContent = "Executing...";
        try {
          const res = await fetch("/api/action", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ...payload, confirm: true, accountId: currentAccount() }),
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Action failed");
          cmdOutEl.value = data.output || "Done";
          cmdMetaEl.textContent = "Executed";
          await load();
        } catch (e) {
          cmdMetaEl.textContent = `Execution failed: ${e.message || e}`;
        }
      }

      execWrapBtn.addEventListener("click", () => {
        executeAction({ action: "wrap_near", amountNear: (wrapAmountEl.value || "1").trim() });
      });

      execSupplyBtn.addEventListener("click", () => {
        executeAction({ action: "supply_usdt_collateral", amountRaw: (supplyRawEl.value || "1000000").trim() });
      });

      exportCsvBtn.addEventListener("click", () => {
        if (!lastSnapshot) {
          exportMetaEl.textContent = "No snapshot to export";
          return;
        }
        const csv = toCsv(lastSnapshot);
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `near-dashboard-${lastSnapshot.accountId}-${Date.now()}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        exportMetaEl.textContent = "Exported";
      });

      refreshBtn.addEventListener("click", () => load().catch((e) => (metaEl.textContent = e.message)));
      load().catch((e) => (metaEl.textContent = e.message));
      setInterval(() => load().catch(() => {}), 30000);
    </script>
  </body>
</html>
