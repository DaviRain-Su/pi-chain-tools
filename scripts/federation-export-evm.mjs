#!/usr/bin/env node
import {
	cpSync,
	mkdirSync,
	readFileSync,
	rmSync,
	writeFileSync,
} from "node:fs";
import path from "node:path";

const ROOT = process.cwd();
const OUT_DIR = path.resolve(
	ROOT,
	process.env.FEDERATION_EXPORT_DIR || "../gradience-repos/chain-evm-tools",
);

function cleanDir(dir) {
	rmSync(dir, { recursive: true, force: true });
	mkdirSync(dir, { recursive: true });
}

function writeJson(filePath, obj) {
	writeFileSync(filePath, `${JSON.stringify(obj, null, 2)}\n`, "utf8");
}

function main() {
	cleanDir(OUT_DIR);
	const packageJson = JSON.parse(
		readFileSync(path.join(ROOT, "package.json"), "utf8"),
	);
	const version = String(packageJson.version || "0.1.0");

	writeJson(path.join(OUT_DIR, "package.json"), {
		name: "@gradience/chain-evm-tools",
		version,
		private: false,
		type: "module",
		description: "EVM chain toolset extracted from pi-chain-tools",
		main: "dist/index.js",
		types: "dist/index.d.ts",
		scripts: {
			build: "tsc -p tsconfig.json",
			typecheck: "tsc --noEmit",
			test: "vitest run",
		},
		dependencies: {
			"@sinclair/typebox":
				packageJson.dependencies?.["@sinclair/typebox"] || "^0.34.41",
		},
		devDependencies: {
			typescript: packageJson.devDependencies?.typescript || "^5.9.2",
			vitest: packageJson.devDependencies?.vitest || "^3.2.4",
		},
	});

	writeJson(path.join(OUT_DIR, "tsconfig.json"), {
		compilerOptions: {
			target: "ES2022",
			module: "NodeNext",
			moduleResolution: "NodeNext",
			declaration: true,
			outDir: "dist",
			strict: true,
			esModuleInterop: true,
			skipLibCheck: true,
		},
		include: ["src/**/*.ts", "index.ts"],
	});

	cpSync(
		path.join(ROOT, "src", "chains", "evm"),
		path.join(OUT_DIR, "src", "chains", "evm"),
		{ recursive: true },
	);
	cpSync(
		path.join(ROOT, "src", "w3rt-core"),
		path.join(OUT_DIR, "src", "w3rt-core"),
		{ recursive: true },
	);

	writeFileSync(
		path.join(OUT_DIR, "index.ts"),
		[
			'export { createEvmToolset } from "./src/chains/evm/toolset.js";',
			'export * from "./src/chains/evm/runtime.js";',
			'export * from "./src/chains/evm/policy.js";',
			'export * from "./src/chains/evm/polymarket.js";',
			'export * from "./src/w3rt-core/index.js";',
			"",
		].join("\n"),
		"utf8",
	);
	writeFileSync(
		path.join(OUT_DIR, "README.md"),
		"# @gradience/chain-evm-tools\n\nPilot extracted package generated by scripts/federation-export-evm.mjs\n",
		"utf8",
	);
	console.log(`[federation-export-evm] generated pilot repo at ${OUT_DIR}`);
}

main();
